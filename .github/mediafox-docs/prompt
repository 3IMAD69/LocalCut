# ğŸ”¥ COMPLETE REWRITE â€” MEDIAFOX EDITOR PREVIEW PLAYER (MD-ONLY SPEC)

## â— Situation
The existing editor preview player is **completely broken**.

### Known failures
- Uses **MediaBunny** â†’ âŒ must be fully removed
- Mono audio media â†’ âŒ silent
- Video + audio on the same track â†’ âŒ audio does not play
- External audio under video â†’ âŒ broken
- Timeline sync is unreliable

This **cannot be fixed incrementally**.  
A **full rewrite** using **MediaFox React library** is required.

---

## ğŸ¯ Objective
Create a **new editor preview player** powered exclusively by **MediaFox React**, fully synced to the editor timeline, with a **correct and deterministic audio pipeline**.

**Primary priority:**  
ğŸ‘‰ Audio must work in **all mono and stereo scenarios**.

---

## ğŸš¨ Absolute Rules
- âŒ Do **not** reuse any old player code
- âŒ Do **not** use MediaBunny
- âŒ Do **not** use `<video>` or `<audio>` HTML tags
- âœ… Use **MediaFox React library only**
- âœ… Timeline is the **single source of truth**
- âœ… Audio correctness is non-negotiable

---

## ğŸ§  Core Design Principles

### Timeline-Driven Playback
- The timeline controls **time**, not MediaFox
- MediaFox renders **only what the timeline requests**
- Seeking, scrubbing, and playback all originate from timeline state

---

## â–¶ï¸ MediaFox Player Core

### Responsibilities
- Initialize MediaFox
- Attach MediaFox renderer to the preview canvas
- Accept timeline time updates
- Drive frame rendering and audio scheduling

### Forbidden Behavior
- MediaFox must never autoplay
- MediaFox must never own playback state
- No internal clocks independent of the timeline

---

## ğŸ•’ Playback & Sync Model

- Timeline emits:
  - `currentTime`
  - `isPlaying`
- Player reacts deterministically:
  - If playing â†’ advance time
  - If paused â†’ render static frame
  - If seeking â†’ flush and resync audio

No drift. No offsets. No guessing.

---

## ğŸ§ Audio System (CRITICAL SECTION)

### Fundamental Rule
**Audio is always independent from video.**

Even when a clip appears as â€œvideo with audioâ€ on the timeline, internally:

- Video decoding = video system
- Audio decoding = audio system

They never share state.

---

### Audio Graph (Conceptual)

MediaFox Audio Source
â†’ Channel Mapper
â†’ Gain (volume)
â†’ Audio Mixer
â†’ MediaFox Output

All audioâ€”embedded or externalâ€”flows through the same graph.

---

## ğŸŸ¢ Mono Audio Fix (Root Cause + Solution)

### Root Cause
- Mono audio was previously routed as if it were stereo
- Media engine assumed channel layout instead of enforcing it
- Result: silent output

### New Behavior (Mandatory)
- Channel count is **explicitly read** from MediaFox metadata
- Mono audio is **explicitly mapped**:
  - Mono â†’ dual output (L = R)
- No implicit channel assumptions
- No auto-muting paths

Mono audio must **always be audible**.

---

## ğŸ¼ Video + Audio on Same Track (FIX)

### Old Behavior
- Video decoding suppressed audio decoding
- Shared pipeline caused audio to be skipped

### New Rule
- If a video clip contains audio:
  - Extract audio as a **separate audio source**
  - Route it through the audio graph like any other audio track

Even if video and audio are on the same timeline track:
- They are **processed independently**
- They remain **sample-synced**

---

## ğŸ”Š Audio Mixing Rules

- All active audio tracks are mixed
- Volume applied per track
- Muted tracks produce silence
- Overlapping audio is summed correctly
- No phase cancellation
- No clipping
- Deterministic order of operations

---

## ğŸï¸ Video Rendering

- MediaFox video renderer only
- Frame selection based on:
timeline.currentTime
- Video never controls playback
- Video never touches audio state

---

## ğŸ§© Timeline Integration

### Timeline Responsibilities
- Define clip start/end
- Define track muting
- Define offsets and trims
- Emit current playback time

### Player Responsibilities
- Resolve which clips are active at current time
- Feed resolved state into MediaFox
- Maintain exact sync

---

## âš›ï¸ React Integration (Editor Preview)

### Preview Behavior
- MediaFox canvas rendered in React
- React subscribes to:
- currentTime
- isPlaying
- UI never manipulates MediaFox directly
- All control flows through timeline state

---

## ğŸ§ª Required Test Scenarios (MUST PASS)

- Mono video with embedded audio â†’ ğŸ”Š audible
- Stereo video with embedded audio â†’ ğŸ”Š audible
- Mono video + mono external audio â†’ ğŸ”Š both audible
- Stereo video + mono external audio â†’ ğŸ”Š both audible
- Video + audio on same track â†’ ğŸ”Š audio plays
- Multiple stacked audio tracks â†’ ğŸ”Š mixed correctly
- Timeline scrubbing â†’ ğŸ”Š stays in sync
- Play / Pause / Seek â†’ ğŸ”Š no dropouts

---

## âŒ What Is Explicitly Forbidden
- HTML media tags
- MediaBunny usage
- Implicit audio routing
- Shared video/audio pipelines
- Legacy logic reuse
- â€œBest effortâ€ audio handling

---

## âœ… Success Definition
If **any** of the following occur:
- Mono audio is silent
- External audio does not play
- Audio drops when stacked
- Audio desyncs from timeline

â¡ï¸ **The rewrite has failed.**

---

## ğŸ§  Final Statement
This is a **clean-slate MediaFox rewrite**.

- Timeline owns time
- MediaFox renders deterministically
- Audio is explicit, isolated, and correct
- Mono audio is treated as a first-class case

**Nothing from the old player survives.**
